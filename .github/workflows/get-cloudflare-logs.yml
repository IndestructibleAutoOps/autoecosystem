name: Get Cloudflare Pages Deployment Logs

on:
  workflow_dispatch:

jobs:
  get_logs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get latest deployment ID
        id: get_deployment_id
        run: |
          ACCOUNT_ID="2fead4a141ec2c677eb3bf0ac535f1d5"
          PROJECT_NAME="autoecoops"
          RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          LATEST_DEPLOYMENT_ID=$(echo "$RESPONSE" | jq -r '.result[0].id')
          echo "Latest Deployment ID: $LATEST_DEPLOYMENT_ID"
          echo "deployment_id=$LATEST_DEPLOYMENT_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Get deployment logs
        run: |
          ACCOUNT_ID="2fead4a141ec2c677eb3bf0ac535f1d5"
          PROJECT_NAME="autoecoops"
          DEPLOYMENT_ID="${{ steps.get_deployment_id.outputs.deployment_id }}"
          
          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "Error: Could not retrieve deployment ID. Exiting."
            exit 1
          fi

          echo "Fetching logs for deployment ID: $DEPLOYMENT_ID"
          curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments/${DEPLOYMENT_ID}/history/logs" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" | jq .
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
